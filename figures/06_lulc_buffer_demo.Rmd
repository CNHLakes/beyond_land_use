---
output: pdf_document
header-includes: 
  - \pagenumbering{gobble}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = "../figures/", fig.width = 7, fig.height = 7)
# setwd("figures")
source("../scripts/99_utils.R")
```

```{r 06_lulc_buffer_demo, echo=FALSE, eval=TRUE}
# setwd("figures")

dt <- readRDS("../data/dt.rds")

llid <- dt$lagoslakeid[2]
ll_pnt <- st_coordinates(
  st_transform(
    query_gis("LAGOS_NE_All_Lakes_4ha_POINTS", "lagoslakeid", llid), 4326))
ll_lake <- st_transform(
  query_gis("LAGOS_NE_All_Lakes_4ha", "lagoslakeid", llid), 4326)
network <- extract_network(lon = ll_pnt[1], 
                                   lat = ll_pnt[2], 
                                   maxsteps = Inf, 
                           buffer_dist = units::as_units(5, "km"),
                           quiet = TRUE)
network <- network[unlist(lapply(
  st_intersects(network, st_transform(ll_lake, st_crs(network))), 
  function(x) length(x) == 0)),]

network_buffer <- st_buffer(network, 100)
nlcd           <- get_nlcd(template = as_Spatial(st_as_sfc(st_bbox(network_buffer))), 
                 label = llid)
network_buffer <- st_transform(network_buffer, projection(nlcd))

nlcd_df <- as.data.frame(nlcd, xy = TRUE) %>%
  dplyr::select(x, y, contains("Value"))
nlcd_df[,3] <- factor(nlcd_df[,3])
names(nlcd_df)[3] <- "value"
cols <- dplyr::filter(pal_nlcd(), code %in% unique(nlcd_df[,3]))


g_map <- ggplot() + 
  geom_raster(data = nlcd_df, aes(x = x, y = y, fill = value)) +
  scale_fill_manual(values = cols$color) +
  geom_sf(data = network_buffer) +
  coord_sf(datum = NULL) +
  theme(legend.position = "none", 
        axis.text = element_blank(), 
        axis.title = element_blank(), 
        line = element_blank(), 
        rect = element_blank(), 
        panel.grid = element_blank()) +
    ggtitle(paste0("llid: ", llid))

join_key <- function(vals){
  res <- vals %>%
    data.frame(code = ., stringsAsFactors = FALSE) %>% 
    count(code) %>%
    left_join(FedData::pal_nlcd(), by = "code") %>%
    dplyr::filter(code != 11)
  res$description <- factor(res$description, 
                            levels = res$description)
  res
} 

buffer_stats <- read.csv("../data/buffer_lulc.csv") %>%
  dplyr::filter(llid == 2745) %>%
  rename(total_n_lake = total_n, 
         n_lake = n) %>%
  mutate(total_n_stream = stream_buffer_area / 1000, 
         n_stream = round((percent_stream / 100) * total_n_stream, 0))

# create a vector of nlcd codes of length n_lake or n_stream
expand_nlcd_codes <- function(x, n_col){
  x_filtered <- x %>%
    dplyr::filter(!is.na(UQ(rlang::sym(n_col))))
  Map(rep, x_filtered$code, x_filtered[,n_col])  
}

lake_buffer_stats   <- join_key(as.character(unlist(
  expand_nlcd_codes(buffer_stats, "n_lake"))))
stream_buffer_stats <- join_key(as.character(unlist(
  expand_nlcd_codes(buffer_stats, "n_stream"))))
nlcd_stats          <- join_key(as.character(values(nlcd)))  

theme_opts <- theme(axis.text.x = element_blank(), 
                    legend.title = element_blank(), 
                    axis.title.x = element_blank())

g_all <- ggplot() + 
  geom_col(data = nlcd_stats, aes(x = description, 
                             y = n, 
                             fill = description)) +
  scale_fill_manual(values = nlcd_stats$color) +
  theme(legend.direction = "horizontal") +
  theme_opts +
  guides(fill = guide_legend(ncol = 2)) +
  ggtitle("Viewport LULC")

g_stream_buffer <- ggplot() + 
  geom_col(data = stream_buffer_stats, aes(x = description, 
                                  y = n, 
                                  fill = description)) +
  scale_fill_manual(values = stream_buffer_stats$color) +
  theme(legend.position = "none") +
  theme_opts +
  ggtitle("Stream buffer LULC")

g_lake_buffer <- ggplot() + 
  geom_col(data = lake_buffer_stats, aes(x = description, 
                                  y = n, 
                                  fill = description)) +
  scale_fill_manual(values = lake_buffer_stats$color) +
  theme(legend.position = "none") +
  theme_opts +
  ggtitle("Lake buffer LULC")

legend <- get_legend(g_all)

plot_grid(g_map, 
  plot_grid(g_all + theme(legend.position = "none"),
            g_lake_buffer, ggplot(),
            g_stream_buffer), 
  legend, ncol = 1) 

```

```{r buffer-lulc_vs_iws-lulc, echo=FALSE}
dt <- readRDS("../data/dt.rds") %>%
  mutate(diff = stream_cultivated_crops - ag_pct) %>%
  drop_na(diff)

# ggplot(data = dt) + 
#   geom_point(aes(x = ag_pct, y = stream_cultivated_crops, color = diff > 0)) + 
#   geom_abline(aes(slope = 1, intercept = 0))
# 
# res_pnt  <- query_gis("LAGOS_NE_All_Lakes_4ha_POINTS", "lagoslakeid", 
#                       dplyr::filter(dt, diff > 0)$lagoslakeid)
res_iws  <- query_gis("IWS", "lagoslakeid", dplyr::filter(dt, diff > 3)$lagoslakeid)

# ggplot() + 
#   geom_sf(data = state_sf()) +
#   geom_sf(data = res_pnt)

library(curl)
library(glue)
library(slippymath)
library(raster)
library(rgdal)

get_image <- function(outpath, iws){
  # outpath <- outpaths[1]
  # iws <- res_iws[1,]
  tile_grid <- bbox_to_tile_grid(st_bbox(
    st_transform(iws, 4326)), max_tiles = 15)

  mapbox_query_string <-
    paste0("https://api.mapbox.com/v4/mapbox.satellite/{zoom}/{x}/{y}.jpg90",
           "?access_token=",
           Sys.getenv("MAPBOX_API_KEY"))
  
  images <- apply(tile_grid$tiles, 1, function(i) {
    url     <- glue(mapbox_query_string, x = i[1], y = i[2], 
                zoom = tile_grid$zoom)
    outfile <- glue("../data/mapbox/{x}_{y}.jpg", x = i[1], y = i[2])
    get_if_not_exists(url, outfile)
    return(outfile)
  })
  
  raster_out <- compose_tile_grid(tile_grid, images)
  
  writeRaster(raster_out, outpath, options="INTERLEAVE=BAND")   
  return(raster_out)
}

# lapply iws's
outpaths <- paste0("../data/mapbox/", res_iws$lagoslakeid, ".tif")
images   <- lapply(seq_along(outpaths), function(i) 
  get_if_not_exists(get_image, outpaths[i], raster::raster, iws = res_iws[i,]))
  
iws_sized <- which(abs(res_iws$IWSAreaHa - median(res_iws$IWSAreaHa)) < 1000)
images_sized <- images[iws_sized]

plotRGB(images_sized[[1]])

res_streams <- lapply(iws_sized, function(x) 
  nhdR::nhd_plus_query(poly = res_iws[x,], dsn = "NHDFlowLine")$sp$NHDFlowLine)

viewRGB(images_sized[[1]]) + mapview(res_streams$sp$NHDFlowLine)

library(tmap)

tm_basemap(leaflet::providers$Stamen.Watercolor) + 
  
  tmap_mode("plot")
tm_basemap(leaflet::providers$Stamen.Terrain) + 
  tm_shape(res_iws[8,]) + tm_fill(alpha = 0) + tm_borders() +
    tm_basemap(server = "OpenTopoMap")
  
  
  tm_tiles(paste0("http://services.arcgisonline.com/arcgis/rest/services/Canvas/",
    "World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}"), group = "Labels")


```