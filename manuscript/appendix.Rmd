---
title: "Appendix"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
header-includes: 
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage{colortbl}
---

\arrayrulecolor{white}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.path = "../figures/", fig.width = 5, fig.height = 5, dev = c("pdf"))
```

```{r read_chunks, cache=FALSE, echo=FALSE}
knitr::read_chunk("../scripts/99_utils.R")
```

```{r source_utils, message=FALSE, results='hide', echo=FALSE, warning=FALSE}
# setwd("scripts")
source("../scripts/99_utils.R")
```

\pagebreak

## Predictor summary table

\includegraphics[width=5in]{"../tables/01_predictors"}

\pagebreak

## Response variable maps

Some obvious data availability differences in New York and Wisconsin. Wisconsin has quite a bit fewer TN measurements.

```{r maps, fig.cap = "Quantile map of lake nutrients.", warning=FALSE, echo = FALSE, eval=TRUE}
knitr::include_graphics("../figures/tptn_maps-1.pdf")
```

## Trophic state

Over 50 percent of our study lakes were eutrophic to hypereutrophic.

```{r data_prep, fig.cap="Lake trophic state", fig.width = 6, fig.height = 3.2, warning=FALSE, message=FALSE}
lg <- lagosne_load("1.087.1")
focal_hu4s <- data.frame(hu4_zoneid = paste0("HU4_", 
                                             c("56", "57", "36", "37", "38")), 
                         stringsAsFactors = FALSE)

dt <- readRDS("../data/dt.rds") %>%
  dplyr::filter(!is.na(chla)) %>%
  mutate(trophic_state = cut(chla, 
                             breaks = c(-Inf, 2.6, 20, 56, Inf), 
                             labels = c("oligotrophic", "mesotrophic", 
                                        "eutrophic", "hypereutrophic"))) %>%
  dplyr::select(chla, trophic_state) %>%
  group_by(trophic_state) %>%
  count() %>%
  ungroup() %>% # rowwise() %>%
  mutate(frac = (n / sum(n)) * 100)

lg_trophic_state <- dplyr::filter(lg$epi_nutr, 
                                  !(lagoslakeid %in%
                                      readRDS("../data/dt.rds")$lagoslakeid)) %>%
  dplyr::filter(!is.na(chla)) %>%
  dplyr::select(chla, lagoslakeid, sampledate) %>%
  group_by(lagoslakeid) %>%
  summarise(chla = median(chla)) %>%
  mutate(trophic_state = cut(chla, 
                             breaks = c(-Inf, 2.6, 20, 56, Inf), 
                             labels = c("oligotrophic", "mesotrophic", 
                                        "eutrophic", "hypereutrophic"))) %>%
  dplyr::select(chla, trophic_state) %>%
  group_by(trophic_state) %>%
  count() %>%
  ungroup() %>% # rowwise() %>%
  mutate(frac = (n / sum(n)) * 100)

dt <- data.frame(`Trophic State` = dt$trophic_state, 
           `Study` = round(dt$frac, 1), 
           `All` = round(lg_trophic_state$frac, 1), 
           stringsAsFactors = FALSE)
dt <- setNames(dt, c("Trophic State", "This Study", "All Lakes"))


# g <- gridExtra::tableGrob(dt, rows = rep("", nrow(dt)))
# grid.draw(g)
```

```{r trophic_state, fig.cap="Lake trophic state", fig.width = 4, fig.height = 3.2, warning=FALSE, message=FALSE}
# waffle
library(waffle)

total_cells <- 41.5
dt_waffle <- dt %>% 
  dplyr::rename(trophic_state = `Trophic State`) %>%
  tidyr::gather(key = "key", value = "value", -trophic_state) %>%
  dplyr::filter(key == "This Study") %>%
  mutate(value = floor((value / 100) * total_cells)) %>%
  arrange(trophic_state)
# sum(dt_waffle$value)
# add_row(`Trophic State` = "oligotrophic", `key` = "This Study", `value` = 2) %>%

ggplot(dt_waffle,
       aes(fill = trophic_state, values = value)) +
  geom_waffle(color = "white", size = 3, n_rows = 4, flip = FALSE) +
  # facet_wrap(~key, ncol = 1) +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_discrete(expand = c(0,0)) +
  shades::lightness(scale_fill_brewer(palette = "Greens", type = "seq"), 
                    shades::delta(-10)) +
  coord_equal() +
  theme_enhance_waffle() + 
  theme(strip.background = element_blank(), 
        rect = element_rect(fill = "transparent"), 
        legend.position = "bottom", 
        title = element_blank(), 
        strip.text = element_text(size = 16), 
        legend.text = element_text(size = 10), 
        legend.key.size = unit(0.5, "line")) + 
  guides(fill = guide_legend(nrow = 1))

# highlighted regions
test <- readRDS("../data/dt.rds") %>%
  mutate(is_focal = hu4_zoneid %in% focal_hu4s$hu4_zoneid) %>%
  dplyr::filter(!is.na(chla)) %>%
  mutate(trophic_state = cut(chla, 
                             breaks = c(-Inf, 2.6, 20, 56, Inf), 
                             labels = c("oligotrophic", "mesotrophic", 
                                        "eutrophic", "hypereutrophic"))) %>%
  dplyr::select(lagoslakeid, is_focal, chla, hu4_zoneid, trophic_state) %>%
  group_by(is_focal, trophic_state) %>%
  count() %>%
  tidyr::spread(trophic_state, n)
```

```{r predictor_maps}
# 
```

\pagebreak

## Fixed effects dotplots of non lulc models and nutrient only models

```{r re-comparison-1, fig.cap = "Population level effect of watershed land-use cover on lake TP and TN. Values shown are posterior medians (filled circles) and 95% credible intervals (solid lines). Also shown is a comparison to a zero effect (dashed line).", warning=FALSE, echo = FALSE}
knitr::include_graphics("../figures/re-comparison_40-1.pdf")
```

```{r fe-1, fig.cap = "Global (fixed effect) coefficient values and credible intervals for best-fit lake TP and TN models. Values that do not overlap zero are shaded in red. Horizontal bars separate coefficients in distinct predictor categories. Coefficient estimates are reported relative to standardized predictor variables centered at zero with unit variance.", warning=FALSE, echo = FALSE}
knitr::include_graphics("../figures/fe_40-1.pdf")
```

```{r re-1, fig.cap = "Regionally varying effect of watershed land-use cover for best-fit lake TP and TN models. Lines shown are 95% credible intervals with median marked by a filled circle. Values that do not overlap the population level estimate are shaded in red.", warning=FALSE, echo = FALSE}
knitr::include_graphics("../figures/re_40-1.pdf")
```
\pagebreak

```{r fe-1, fig.cap = "Global (fixed effect) coefficient values and credible intervals for best-fit lake TP and TN models. Values that do not overlap zero are shaded in red. Horizontal bars separate coefficients in distinct predictor categories. Coefficient estimates are reported relative to standardized predictor variables centered at zero with unit variance.", warning=FALSE, echo = FALSE}
knitr::include_graphics("../figures/fe_nolulc-1.pdf")
```

\pagebreak

## Bivariate relationships among predictors and lake nutrients

We examined bivariate relationships between lake nutrient concentrations and predictors to determine, at least to first-approximation, the likely drivers of lake nutrients (Figure 2). 
We found large differences between the drivers of lake phosphorus and lake nitrogen concentrations. 
For example, max depth and baseflow had a much larger effect on P than N. Pearson’s correlation coefficients for these relationships were XX and YY respectively. 
In contrast, watershed land-use corn cover, fertilizer inputs, and riparian buffer configuration appear to have a larger effect on N than P Pearson’s correlation coefficients for these relationships were XX, YY, and ZZ respectively. 

```{r exploratory_dotplot, fig.cap = "Dotplots showing absolute value Pearson's correlation coefficients. Dots are colored according to predictor categories.", warning=FALSE, echo = FALSE}
knitr::include_graphics("../figures/dotplot-1.pdf")
```

\pagebreak

## Correlations among predictor variables

There is clearly a cluster of related predictor variables that includes most nutrient input, Ag land-use, and buffer configuration measures.

```{r exploratory_heatmap, fig.cap = "Heatmap showing absolute value correlation coefficients.", warning=FALSE, echo = FALSE, eval=TRUE}
knitr::include_graphics("../figures/08_exploratory_dotplot-1.pdf")
```

\pagebreak

## The Cropland Data Layer

The National land cover database (NLCD) is more typically used in macroecology studies. In our paper, we wanted to go beyond the coarse categories in the NLCD and test relationships with individual crops. The Cropland Data Layer (CDL) is a product that allowed us to do this. Because the CDL is more granular that the NLCD we could not directly compare them. Instead, we aggregated all the CDL categories associated with agriculture (also pasture) and compared these values for each watershed with the corresponding NLCD estimates.

```{r nlcd-versus-cdl, fig.cap = "Comparison between NLCD (2011) derived and CDL (2010) derived total watershed ag and watershed pasture cover. Line is 1:1 not a  regression best fit.", warning=FALSE, echo = FALSE, eval=TRUE}
knitr::include_graphics("../figures/04_nlcd-versus-cdl-1.pdf")
```

```{r nlcd-versus-cdl_map, fig.cap = "Example of increasing granularity for total Ag to Ag versus pasture, to pasture versus specific crops. For illustration in this example, only corn, soybeans, and pasture are shown. Rather than all CDL land-use categories.", warning=FALSE, echo = FALSE, eval = TRUE}
knitr::include_graphics("../figures/cdl_vs_nlcd-1.pdf")
```

\pagebreak

## Demo of watersheds and buffer configuration

Here are two lakes each with the same percent Ag in their watersheds (red outlines). However, the lake on the left (Lake Carleton) has a riparian buffer (teal outlines) with a much higher percentage of Ag relative to the lake on the right (Argyle Lake).

```{r big_stream_ag, fig.cap = "Stream buffer Ag compared to IWS Ag.", warning=FALSE, echo = FALSE, eval = TRUE}
knitr::include_graphics("../figures/satellite-1.pdf")
```

\pagebreak

```{r lulc_vs_iws-lulc, fig.cap = "Stream buffer versus IWS lulc.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/09_stream_buffer-1.pdf")
```

```{r cdl_viewport, fig.cap = "CDL landuse cover in example IWS.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/cdl_viewport-1.pdf")
```

```{r hierarchical_demo, fig.cap = "A) Global (dashed line) and regional (solid lines) fits to the relationship between lake phosphorus and IWS Ag. land use cover from the 2011 NLCD. A hierarchical model would weight these relationships by sample size (darker lines = higher sample size). B) Number of lakes per region.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/02_hierarchical_demo-1.pdf")
```

```{r wetland_potential, fig.cap = "A) gSSURGO wetland potential versus National Wetlands Inventory cover. B) Locations of lakes where these number differ by more than 30 percent.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/03_wetland_potential-1.pdf")
```

```{r cafos, fig.cap = "Livestock data from the 2007 USDA Census of Agriculture.", warning=FALSE, echo = FALSE, eval=FALSE, eval=FALSE}
knitr::include_graphics("../figures/05_cafos-1.pdf")
```

```{r lulc_buffers, fig.cap = "Landuse cover in stream buffers.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/06_lulc_buffer_demo-1.pdf")
```

```{r county_extent, fig.cap = "Number of lake watersheds per county where lakes are limited to those with high agricultural land-use cover (greater than 40 percent) and water quality data in LAGOS from at least 3 sampling events between 2000 and 2010.", warning=FALSE, echo = FALSE, eval = FALSE}
knitr::include_graphics("../figures/01_county_extent-1.pdf")
```