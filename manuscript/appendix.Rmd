---
title: "Appendix"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
header-includes: 
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage{colortbl}
---

\arrayrulecolor{white}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.path = "../figures/", fig.width = 5, fig.height = 5, dev = c("pdf"))
```

```{r read_chunks, cache=FALSE, echo=FALSE}
knitr::read_chunk("../scripts/99_utils.R")
```

```{r source_utils, message=FALSE, results='hide', echo=FALSE, warning=FALSE}
# setwd("scripts")
source("../scripts/99_utils.R")
```

\pagebreak

```{r nlcd-versus-cdl_map, fig.cap = "Example of increasing granularity for total Ag to Ag versus pasture, to pasture versus specific crops. For illustration in this example, only corn, soybeans, and pasture are shown rather than all CDL land-use categories.", warning=FALSE, echo = FALSE, eval = TRUE}
knitr::include_graphics("../figures/cdl_vs_nlcd-1.pdf")
```

\pagebreak

\begin{center}
\includegraphics[width=5in]{"../tables/02_cdl_key"}
\end{center}

```{r 02_cdl_key, results='asis', warning=FALSE, echo = FALSE}
knitr::kable('', col.names = NULL, caption = "CDL category definitions. See code supplement for listing of variables classified as 'ag'")
```

\pagebreak

<!-- ## Predictor summary table -->

<!-- \includegraphics[width=5in]{"../tables/01_predictors"} -->

<!-- ```{r 03_model_summary, results='asis', warning=FALSE, echo = FALSE} -->
<!-- knitr::kable('', col.names = NULL, caption = "Diagnostics for each model listed by regionally varying coefficient. Table is sorted by decreasing R2 and expected log predictive density.") -->
<!-- ``` -->

<!-- \pagebreak -->

<!-- ## Percent agriculture versus lake TP and TN -->

```{r ag-scatter, fig.cap="Lake nutrient concentrations versus percent watershed agriculture.", fig.width = 5, fig.height = 3.2, warning=FALSE, message=FALSE}
dt <- readRDS("../data/dt.rds")

# fit_tn      <- lm(log(tn) ~ log(ag), data = dt)
# fit_tn_pred <- data.frame(tn = fit_tn$model$`log(tn)`, 
#                           tn_pred = fit_tn$fitted.values, 
#                           stringsAsFactors = FALSE)
# ggplot(data = fit_tn_pred) + 
#   geom_point(aes(x = tn, y = tn_pred)) +
#   geom_abline(slope = 1)
# 
# fit_tp      <- lm(log(tp) ~ log(ag), data = dt)
# fit_tp_pred <- data.frame(tp = fit_tp$model$`log(tp)`, 
#                           tp_pred = fit_tp$fitted.values, 
#                           stringsAsFactors = FALSE)
# ggplot(data = fit_tp_pred) + 
#   geom_point(aes(x = tp, y = tp_pred)) +
#   geom_abline(slope = 1)

cowplot::plot_grid(
ggplot(data = dt) + 
  geom_point(aes(x = log(ag), y = log(tn))) + 
  ylab("log(TN) (ug/L)") +
  xlab("log(Percent Agriculture)"), 
ggplot(data = dt) + 
  geom_point(aes(x = log(ag), y = log(tp))) +
  ylab("log(TP) (ug/L)") +
  xlab("log(Percent Agriculture)")
)
  
```

\pagebreak

<!-- ## Response variable maps -->

<!-- Some obvious data availability differences in New York and Wisconsin. Wisconsin has quite a bit fewer TN measurements. -->

<!-- ```{r maps, fig.cap = "Quantile map of lake nutrients.", warning=FALSE, echo = FALSE, eval=TRUE} -->
<!-- knitr::include_graphics("../figures/tptn_maps-1.pdf") -->
<!-- ``` -->

<!-- ## Trophic state -->

<!-- Over 35 percent of our study lakes were eutrophic to hypereutrophic. -->

```{r data_prep, fig.cap="Lake trophic state", fig.width = 6, fig.height = 3.2, warning=FALSE, message=FALSE}
lg         <- lagosne_load("1.087.1")
dt         <- readRDS("../data/dt.rds")
focal_hu4s <- data.frame(hu4_zoneid = unique(dt$hu4_zoneid), 
                         stringsAsFactors = FALSE)

dt <- dt %>%
  dplyr::filter(!is.na(chla)) %>%
  mutate(trophic_state = cut(chla, 
                             breaks = c(-Inf, 2.6, 20, 56, Inf), 
                             labels = c("oligotrophic", "mesotrophic", 
                                        "eutrophic", "hypereutrophic"))) %>%
  dplyr::select(chla, trophic_state) %>%
  group_by(trophic_state) %>%
  count() %>%
  ungroup() %>% # rowwise() %>%
  mutate(frac = (n / sum(n)) * 100)

lg_trophic_state <- dplyr::filter(lg$epi_nutr, 
                                  !(lagoslakeid %in%
                                      readRDS("../data/dt.rds")$lagoslakeid)) %>%
  dplyr::filter(!is.na(chla)) %>%
  dplyr::select(chla, lagoslakeid, sampledate) %>%
  group_by(lagoslakeid) %>%
  summarise(chla = median(chla)) %>%
  mutate(trophic_state = cut(chla, 
                             breaks = c(-Inf, 2.6, 20, 56, Inf), 
                             labels = c("oligotrophic", "mesotrophic", 
                                        "eutrophic", "hypereutrophic"))) %>%
  dplyr::select(chla, trophic_state) %>%
  group_by(trophic_state) %>%
  count() %>%
  ungroup() %>% # rowwise() %>%
  mutate(frac = (n / sum(n)) * 100)

dt <- data.frame(`Trophic State` = dt$trophic_state, 
           `Study` = round(dt$frac, 1), 
           `All` = round(lg_trophic_state$frac, 1), 
           stringsAsFactors = FALSE)
dt <- setNames(dt, c("Trophic State", "This Study", "All Lakes"))


# g <- gridExtra::tableGrob(dt, rows = rep("", nrow(dt)))
# grid.draw(g)
```

```{r trophic_state, fig.cap="Lake trophic state in our study lakes versus all lakes in the study extent.", fig.width = 4, fig.height = 3.2, warning=FALSE, message=FALSE}

dt_bar <- tidyr::pivot_longer(dt, -`Trophic State`) %>%
  group_by(name) %>%
  mutate(ymax = cumsum(value),           
         ymin = c(0, head(ymax, n = -1)))

ggplot(data = dt_bar) +
  geom_rect(aes(fill = `Trophic State`, ymax = ymax, ymin = ymin, xmin = 3, xmax = 4)) +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank()) +
  ylab("Percent of Lakes") +
  facet_wrap(~name) 

# # waffle
# library(waffle)
# 
# total_cells <- 41.5
# dt_waffle <- dt %>% 
#   dplyr::rename(trophic_state = `Trophic State`) %>%
#   tidyr::gather(key = "key", value = "value", -trophic_state) %>%
#   dplyr::filter(key == "This Study") %>%
#   mutate(value = floor((value / 100) * total_cells)) %>%
#   arrange(trophic_state)
# # sum(dt_waffle$value)
# # add_row(`Trophic State` = "oligotrophic", `key` = "This Study", `value` = 2) %>%
# 
# ggplot(dt_waffle,
#        aes(fill = trophic_state, values = value)) +
#   geom_waffle(color = "white", size = 3, n_rows = 4, flip = FALSE) +
#   # facet_wrap(~key, ncol = 1) +
#   scale_x_discrete(expand = c(0,0)) +
#   scale_y_discrete(expand = c(0,0)) +
#   shades::lightness(scale_fill_brewer(palette = "Greens", type = "seq"), 
#                     shades::delta(-10)) +
#   coord_equal() +
#   theme_enhance_waffle() + 
#   theme(strip.background = element_blank(), 
#         rect = element_rect(fill = "transparent"), 
#         legend.position = "bottom", 
#         title = element_blank(), 
#         strip.text = element_text(size = 16), 
#         legend.text = element_text(size = 10), 
#         legend.key.size = unit(0.5, "line")) + 
#   guides(fill = guide_legend(nrow = 1))
# 
# # highlighted regions
# test <- readRDS("../data/dt.rds") %>%
#   mutate(is_focal = hu4_zoneid %in% focal_hu4s$hu4_zoneid) %>%
#   dplyr::filter(!is.na(chla)) %>%
#   mutate(trophic_state = cut(chla, 
#                              breaks = c(-Inf, 2.6, 20, 56, Inf), 
#                              labels = c("oligotrophic", "mesotrophic", 
#                                         "eutrophic", "hypereutrophic"))) %>%
#   dplyr::select(lagoslakeid, is_focal, chla, hu4_zoneid, trophic_state) %>%
#   group_by(is_focal, trophic_state) %>%
#   count() %>%
#   tidyr::spread(trophic_state, n)
```

```{r predictor_maps}
# 
```

<!-- \pagebreak -->

<!-- ## Model results when lake are restricted to > 40% watershed agriculture -->

<!-- ```{r re-comparison_40-1, fig.cap = "Population level effect of watershed land-use cover on lake TP and TN from six candidate models for lakes with greater than 40% watershed agricultural land-use. Values shown are posterior medians (filled circles) and 95% credible intervals (solid lines). Also shown is a comparison to a zero effect (dashed line).", warning=FALSE, echo = FALSE} -->
<!-- knitr::include_graphics("../figures/re-comparison_40-1.pdf") -->
<!-- ``` -->

<!-- ```{r fe_40-1, fig.cap = "Global (fixed effect) coefficient values and credible intervals for best-fit lake TP and TN models for lakes with greater than 40% watershed agricultural land-use. Values that do not overlap zero are shaded in red. Horizontal bars separate coefficients in distinct predictor categories. Coefficient estimates are reported relative to standardized predictor variables centered at zero with unit variance.", warning=FALSE, echo = FALSE} -->
<!-- knitr::include_graphics("../figures/fe_40-1.pdf") -->
<!-- ``` -->

<!-- ```{r re_40-1, fig.cap = "Regionally varying effect of watershed land-use cover for best-fit lake TP and TN models for lakes with greater than 40% watershed agricultural land-use. Lines shown are 95% credible intervals with median marked by a filled circle. Values that do not overlap the population level estimate are shaded in red.", warning=FALSE, echo = FALSE} -->
<!-- knitr::include_graphics("../figures/re_40-1.pdf") -->
<!-- ``` -->
\pagebreak

<!-- ## Model results when land-use predictors are excluded -->

```{r fe_nolulc-1, fig.cap = "Global (fixed effect) coefficient values and credible intervals for best-fit lake TP and TN models when land-use predictors are excluded. Values that do not overlap zero are shaded in red. Horizontal bars separate coefficients in distinct predictor categories. Coefficient estimates are reported relative to standardized predictor variables centered at zero with unit variance.", warning=FALSE, echo = FALSE}
knitr::include_graphics("../figures/fe_nolulc-1.pdf")
```

\pagebreak

<!-- ## Bivariate relationships among predictors and lake nutrients -->

<!-- We examined bivariate relationships between lake nutrient concentrations and predictors to determine, at least to first-approximation, the likely drivers of lake nutrients (Figure 2).  -->
<!-- We found large differences between the drivers of lake phosphorus and lake nitrogen concentrations.  -->
<!-- For example, max depth and baseflow had a much larger effect on P than N. Pearson’s correlation coefficients for these relationships were XX and YY respectively.  -->
<!-- In contrast, watershed land-use corn cover, fertilizer inputs, and riparian buffer configuration appear to have a larger effect on N than P Pearson’s correlation coefficients for these relationships were XX, YY, and ZZ respectively.  -->

```{r exploratory_dotplot, fig.cap = "Dotplots showing absolute value Pearson's correlation coefficients. Dots are colored according to predictor categories.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/dotplot-1.pdf")
```

\pagebreak

```{r eval = FALSE}
# brute force check random slopes
# dt <- readRDS("data/dt.rds")
dt <- readRDS("data/dt_scaled.rds")

ggplot(data = dt) +
  geom_point(aes(x = forest, y = tp, color = hu4_zoneid))

res <- list()
for(i in unique(dt$hu4_zoneid)){
  dt_sub <- dplyr::filter(dt, hu4_zoneid == i)
  print(i)
  print(nrow(dt_sub))
  if(nrow(dt_sub) > 4){
  res[[i]] <- data.frame(
    n = nrow(dt_sub), 
  estimate = broom::tidy(cor.test(
    dt_sub$forest, dt_sub$tp
    ))$estimate, 
  stringsAsFactors = FALSE)
  }else{
    res[[i]] <- data.frame(n = NA, 
                           estimate = NA,
                           stringsAsFactors = FALSE)
  }
}
  
res <- dplyr::bind_rows(res)
res <- dplyr::filter(res, !is.na(n))
  
ggplot(data = res, aes(x = estimate, y = 1, color = n)) +
  geom_point()
```

\pagebreak

<!-- ## Correlations among predictor variables -->

<!-- There is clearly a cluster of related predictor variables that includes most nutrient input, Ag land-use, and buffer configuration measures. -->

```{r exploratory_heatmap, fig.cap = "Heatmap showing absolute value correlation coefficients among predictor variables.", warning=FALSE, echo = FALSE, eval=TRUE}
knitr::include_graphics("../figures/08_exploratory_dotplot-1.pdf")
```

```{r coef-summary-table}
gg_tp <- read.csv("../data/gg_tp.csv", stringsAsFactors = FALSE) %>%
  dplyr::filter(nchar(pretty) > 0) %>%
  dplyr::select(-signif, -category) %>%
  setNames(c("variable", "5%", "50%", "95%", "SD")) %>%
  mutate_if(is.numeric, function(x) round(x, 2))
gg_tn <- read.csv("../data/gg_tn.csv", stringsAsFactors = FALSE) %>%
  dplyr::filter(nchar(pretty) > 0) %>%
  dplyr::select(-signif, -category) %>%
  setNames(c("variable", "5%", "50%", "95%", "SD")) %>%
  mutate_if(is.numeric, function(x) round(x, 2))

knitr::kable(gg_tp, caption = "Coefficient summaries for top-ranked TP model.")

knitr::kable(gg_tn, caption = "Coefficient summaries for top-ranked TN model.")

```

<!-- \pagebreak -->

<!-- ## The Cropland Data Layer -->

<!-- The National land cover database (NLCD) is more typically used in macroecology studies. In our paper, we wanted to go beyond the coarse categories in the NLCD and test relationships with individual crops. The Cropland Data Layer (CDL) is a product that allowed us to do this. Because the CDL is more granular that the NLCD we could not directly compare them. Instead, we aggregated all the CDL categories associated with agriculture (also pasture) and compared these values for each watershed with the corresponding NLCD estimates. -->

```{r nlcd-versus-cdl, fig.cap = "Comparison between NLCD (2011) derived and CDL (2010) derived total watershed ag and watershed pasture cover. Line is 1:1 not a  regression best fit.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/04_nlcd-versus-cdl-1.pdf")
```

<!-- ## Demo of watersheds and buffer configuration -->

<!-- Here are two lakes each with the same percent Ag in their watersheds (red outlines). However, the lake on the left (Lake Carleton) has a riparian buffer (teal outlines) with a much higher percentage of Ag relative to the lake on the right (Argyle Lake). -->

```{r big_stream_ag, fig.cap = "Stream buffer Ag compared to IWS Ag.", warning=FALSE, echo = FALSE, eval = FALSE}
knitr::include_graphics("../figures/satellite-1.pdf")
```

```{r lulc_vs_iws-lulc, fig.cap = "Stream buffer versus IWS lulc.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/09_stream_buffer-1.pdf")
```

```{r cdl_viewport, fig.cap = "CDL landuse cover in example IWS.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/cdl_viewport-1.pdf")
```

```{r hierarchical_demo, fig.cap = "A) Global (dashed line) and regional (solid lines) fits to the relationship between lake phosphorus and IWS Ag. land use cover from the 2011 NLCD. A hierarchical model would weight these relationships by sample size (darker lines = higher sample size). B) Number of lakes per region.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/02_hierarchical_demo-1.pdf")
```

```{r wetland_potential, fig.cap = "A) gSSURGO wetland potential versus National Wetlands Inventory cover. B) Locations of lakes where these number differ by more than 30 percent.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/03_wetland_potential-1.pdf")
```

```{r cafos, fig.cap = "Livestock data from the 2007 USDA Census of Agriculture.", warning=FALSE, echo = FALSE, eval=FALSE, eval=FALSE}
knitr::include_graphics("../figures/05_cafos-1.pdf")
```

```{r lulc_buffers, fig.cap = "Landuse cover in stream buffers.", warning=FALSE, echo = FALSE, eval=FALSE}
knitr::include_graphics("../figures/06_lulc_buffer_demo-1.pdf")
```

```{r county_extent, fig.cap = "Number of lake watersheds per county where lakes are limited to those with high agricultural land-use cover (greater than 40 percent) and water quality data in LAGOS from at least 3 sampling events between 2000 and 2010.", warning=FALSE, echo = FALSE, eval = FALSE}
knitr::include_graphics("../figures/01_county_extent-1.pdf")
```